<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• ƒ∞dari Y√∂netim Uygulamasƒ± - Real-Time Gantt Chart</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Firebase real-time indicator */
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .firebase-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Real-time collaboration indicators */
        .user-avatar {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FF6B6B;
            color: white;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .editing-indicator {
            animation: editingGlow 1.5s infinite alternate;
        }

        @keyframes editingGlow {
            from { box-shadow: 0 0 5px rgba(255, 193, 7, 0.5); }
            to { box-shadow: 0 0 15px rgba(255, 193, 7, 0.8); }
        }

        /* Activity feed enhancement */
        .activity-feed {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            overflow: hidden;
            z-index: 999;
            transition: all 0.3s ease;
            transform: translateY(calc(100% - 60px));
        }

        .activity-feed:hover,
        .activity-feed.expanded {
            transform: translateY(0);
        }

        .activity-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-content {
            max-height: 340px;
            overflow-y: auto;
            padding: 0;
        }

        .activity-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .activity-user {
            font-weight: 600;
            color: #667eea;
        }

        .activity-time {
            color: #999;
            font-size: 0.75rem;
            margin-top: 4px;
        }

        /* Enhanced controls */
        .controls .firebase-indicator {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .online-users {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            margin-left: auto;
        }

        .online-user {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            border: 2px solid white;
        }

        .metin { background: #FF6B6B; }
        .onur { background: #4ECDC4; }

        /* Draggable Notes Styles */
        .gantt-note {
            position: absolute;
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 120px;
            max-width: 200px;
            font-size: 0.8rem;
            line-height: 1.3;
            cursor: move;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
            word-wrap: break-word;
        }

        .gantt-note.yellow {
            background: linear-gradient(135deg, #FFE066, #FFD700);
            border: 2px solid #FFC107;
        }

        .gantt-note.blue {
            background: linear-gradient(135deg, #87CEEB, #4682B4);
            border: 2px solid #4169E1;
        }

        .gantt-note.green {
            background: linear-gradient(135deg, #90EE90, #32CD32);
            border: 2px solid #228B22;
        }

        .gantt-note.orange {
            background: linear-gradient(135deg, #FFB347, #FF8C00);
            border: 2px solid #FF6347;
        }

        .gantt-note.pink {
            background: linear-gradient(135deg, #FFB6C1, #FF69B4);
            border: 2px solid #FF1493;
        }

        .gantt-note:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .gantt-note.dragging {
            opacity: 0.8;
            transform: rotate(2deg);
            z-index: 1000;
        }

        .note-content {
            margin-bottom: 5px;
            font-weight: 500;
        }

        .note-author {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #FF6B6B;
            color: white;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .note-delete {
            position: absolute;
            top: -5px;
            left: -5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            font-size: 0.6rem;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid white;
        }

        .gantt-note:hover .note-delete {
            display: flex;
        }

        .note-timestamp {
            font-size: 0.6rem;
            color: #666;
            margin-top: 3px;
        }

        /* Ensure gantt-body has relative positioning for notes */
        .gantt-body {
            position: relative;
        }
    </style>
</head>
<body>
    <!-- Firebase Status Indicator -->
    <div class="firebase-status" id="firebaseStatus">
        <div class="firebase-dot"></div>
        <span>üî• Real-Time Active</span>
    </div>

    <!-- Activity Feed -->
    <div class="activity-feed" id="activityFeed">
        <div class="activity-header" onclick="toggleActivityFeed()">
            <span>üìä Canlƒ± Aktivite</span>
            <span id="onlineCounter">üë• 2 online</span>
        </div>
        <div class="activity-content" id="activityContent">
            <div class="activity-item">
                <div><span class="activity-user">System</span> Firebase baƒülantƒ±sƒ± kuruldu</div>
                <div class="activity-time">Az √∂nce</div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üî• ƒ∞dari Y√∂netim Uygulamasƒ± - Faz 1</h1>
            <p class="project-info">1 Temmuz - 10 Ekim 2025 (15 Hafta) | Aragon Bili≈üim | Real-Time Collaboration</p>
            <div class="controls">
                <button id="addTask" class="btn btn-primary">‚ûï G√∂rev Ekle</button>
                <button id="addNote" class="btn btn-info">üìù Not Ekle</button>
                <button id="autoSchedule" class="btn btn-warning">ü§ñ Otomatik Planla</button>
                <div class="zoom-controls">
                    <button id="zoomOut" class="btn btn-outline" title="Uzakla≈ütƒ±r">üîç-</button>
                    <span id="zoomLevel">100%</span>
                    <button id="zoomIn" class="btn btn-outline" title="Yakƒ±nla≈ütƒ±r">üîç+</button>
                    <button id="zoomReset" class="btn btn-outline" title="Sƒ±fƒ±rla">‚ü≤</button>
                </div>
                <button id="saveProject" class="btn btn-success">üíæ Projeyi Kaydet</button>
                <button id="exportChart" class="btn btn-secondary">üì§ Grafik Dƒ±≈üa Aktar</button>
                <button id="toggleView" class="btn btn-info">üëÅÔ∏è G√∂r√ºn√ºm Deƒüi≈ütir</button>
                
                <!-- Online Users Indicator -->
                <div class="online-users">
                    <div class="online-user metin" title="Metin">M</div>
                    <div class="online-user onur" title="Onur">O</div>
                    <span style="color: white; font-size: 0.8rem;">Real-Time</span>
                </div>
            </div>
        </header>

        <div class="project-overview">
            <div class="phase-summary">
                <h3>Proje Fazlarƒ±</h3>
                <div class="phase-cards">
                    <div class="phase-card">
                        <h4>B√∂l√ºm 1: Sistem Mimarƒ±</h4>
                        <span class="phase-weeks">3 Hafta</span>
                    </div>
                    <div class="phase-card">
                        <h4>B√∂l√ºm 2: Kullanƒ±cƒ± Y√∂netimi</h4>
                        <span class="phase-weeks">3 Hafta</span>
                    </div>
                    <div class="phase-card">
                        <h4>B√∂l√ºm 3: Personel Y√∂netimi</h4>
                        <span class="phase-weeks">4 Hafta</span>
                    </div>
                    <div class="phase-card">
                        <h4>B√∂l√ºm 4: ƒ∞≈ü Y√∂netimi</h4>
                        <span class="phase-weeks">3 Hafta</span>
                    </div>
                    <div class="phase-card">
                        <h4>B√∂l√ºm 5: Bildirim & Analitik</h4>
                        <span class="phase-weeks">2 Hafta</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="legend">
            <h3>Durum G√∂stergeleri</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="status-indicator not-started"></div>
                    <span>Ba≈ülanmadƒ±</span>
                </div>
                <div class="legend-item">
                    <div class="status-indicator in-progress"></div>
                    <span>Devam Ediyor</span>
                </div>
                <div class="legend-item">
                    <div class="status-indicator completed"></div>
                    <span>Tamamlandƒ±</span>
                </div>
                <div class="legend-item">
                    <div class="status-indicator delayed"></div>
                    <span>Gecikmi≈ü</span>
                </div>
                <div class="legend-item">
                    <div class="status-indicator critical"></div>
                    <span>Kritik</span>
                </div>
                <div class="legend-item">
                    <div class="status-indicator editing-indicator"></div>
                    <span>üî• D√ºzenleniyor (Real-Time)</span>
                </div>
            </div>
        </div>

        <div class="gantt-container">
            <div class="gantt-chart">
                <div class="gantt-header">
                    <div class="task-header">
                        <div class="task-name">G√∂rev / Mod√ºl</div>
                        <div class="task-info">Bilgiler</div>
                    </div>
                    <div class="timeline-header" id="timelineHeader"></div>
                </div>
                <div class="gantt-body" id="ganttBody"></div>
            </div>
        </div>

        <div class="bottom-panel">
            <div class="notes-panel" id="notesPanel">
                <h3>üî• Real-Time G√∂rev Notlarƒ±</h3>
                <div class="notes-content">
                    <p>Bir g√∂rev se√ßerek notlarƒ±nƒ± g√∂r√ºnt√ºleyin ve d√ºzenleyin. Deƒüi≈üiklikler anƒ±nda diƒüer kullanƒ±cƒ±lara yansƒ±r!</p>
                </div>
            </div>

            <div class="progress-panel">
                <h3>üìä Proje ƒ∞lerlemesi</h3>
                <div class="progress-stats">
                    <div class="stat-item">
                        <span class="stat-label">Toplam G√∂rev:</span>
                        <span class="stat-value" id="totalTasks">15</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Tamamlanan:</span>
                        <span class="stat-value" id="completedTasks">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ƒ∞lerleme:</span>
                        <span class="stat-value" id="progressPercentage">0%</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <!-- Firebase Real-time Stats -->
                <div class="firebase-stats" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                    <h4 style="margin-bottom: 10px; color: #667eea;">üî• Real-Time ƒ∞statistikler</h4>
                    <div class="progress-stats">
                        <div class="stat-item">
                            <span class="stat-label">Aktif Kullanƒ±cƒ±:</span>
                            <span class="stat-value" id="activeUsers">2</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Devam Eden:</span>
                            <span class="stat-value" id="inProgressTasks">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Geciken:</span>
                            <span class="stat-value" id="delayedTasks">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for editing tasks -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>G√∂rev Detaylarƒ±</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="form-group">
                        <label for="taskName">G√∂rev Adƒ±:</label>
                        <input type="text" id="taskName" required>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">A√ßƒ±klama:</label>
                        <textarea id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Ba≈ülangƒ±√ß Tarihi:</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">Biti≈ü Tarihi:</label>
                        <input type="date" id="endDate" required>
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">Durum:</label>
                        <select id="taskStatus">
                            <option value="not-started">Ba≈ülanmadƒ±</option>
                            <option value="in-progress">Devam Ediyor</option>
                            <option value="completed">Tamamlandƒ±</option>
                            <option value="delayed">Gecikmi≈ü</option>
                            <option value="critical">Kritik</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">√ñncelik:</label>
                        <select id="taskPriority">
                            <option value="low">D√º≈ü√ºk</option>
                            <option value="medium">Orta</option>
                            <option value="high">Y√ºksek</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskProgress">ƒ∞lerleme (%):</label>
                        <input type="range" id="taskProgress" min="0" max="100" value="0">
                        <span id="progressValue">0%</span>
                    </div>
                    <div class="form-group">
                        <label for="taskNotes">Notlar:</label>
                        <textarea id="taskNotes" rows="4" placeholder="Bu g√∂rev hakkƒ±nda notlar ekleyin..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskPhase">Faz:</label>
                        <select id="taskPhase">
                            <option value="1">B√∂l√ºm 1: Sistem Mimarƒ±</option>
                            <option value="2">B√∂l√ºm 2: Kullanƒ±cƒ± Y√∂netimi</option>
                            <option value="3">B√∂l√ºm 3: Personel Y√∂netimi</option>
                            <option value="4">B√∂l√ºm 4: ƒ∞≈ü Y√∂netimi</option>
                            <option value="5">B√∂l√ºm 5: Bildirim & Analitik</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveTask" class="btn btn-primary">G√∂revi Kaydet</button>
                <button type="button" id="deleteTask" class="btn btn-danger">G√∂revi Sil</button>
                <button type="button" class="btn btn-secondary close-modal">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding notes -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Yeni Not Ekle</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <div class="form-group">
                        <label for="noteContent">Not ƒ∞√ßeriƒüi:</label>
                        <textarea id="noteContent" rows="4" placeholder="Notunuzu buraya yazƒ±n..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="noteColor">Not Rengi:</label>
                        <select id="noteColor">
                            <option value="yellow">üü° Sarƒ± (Varsayƒ±lan)</option>
                            <option value="blue">üîµ Mavi</option>
                            <option value="green">üü¢ Ye≈üil</option>
                            <option value="orange">üü† Turuncu</option>
                            <option value="pink">ü©∑ Pembe</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveNote" class="btn btn-primary">üìù Notu Kaydet</button>
                <button type="button" class="btn btn-secondary close-modal">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <!-- Include original JavaScript functionality -->
    <script src="script.js"></script>
    
    <!-- Firebase Real-time Integration -->
    <script type="module">
        // Firebase imports and configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            serverTimestamp,
            query,
            orderBy,
            limit 
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCHPx-P8-iNuZSB-VQXNoA8joFUKflzZ48",
            authDomain: "gantt-collaboration.firebaseapp.com",
            projectId: "gantt-collaboration",
            storageBucket: "gantt-collaboration.firebasestorage.app",
            messagingSenderId: "943434253016",
            appId: "1:943434253016:web:5745ae8ad2011f0e954dad"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Get current user
        let currentUser = prompt("Adƒ±nƒ±zƒ± girin (Metin/Onur):") || "Anonim";
        console.log(`üî• ${currentUser} olarak giri≈ü yapƒ±ldƒ±`);

        // Real-time listeners
        let firestoreTasks = [];
        let activities = [];
        let firestoreNotes = [];

        // Initialize real-time sync
        function initializeRealTimeSync() {
            // Listen to tasks
            const tasksRef = collection(db, 'tasks');
            const tasksQuery = query(tasksRef, orderBy('createdAt', 'desc'));
            
            onSnapshot(tasksQuery, (snapshot) => {
                firestoreTasks = [];
                snapshot.forEach((doc) => {
                    firestoreTasks.push({ id: doc.id, ...doc.data() });
                });
                
                // Merge with existing project data and update display
                mergeFirebaseData();
                console.log(`üìä ${firestoreTasks.length} Firebase g√∂revi y√ºklendi`);
            });

            // Listen to activities
            const activitiesRef = collection(db, 'activities');
            const activitiesQuery = query(activitiesRef, orderBy('timestamp', 'desc'), limit(20));
            
            onSnapshot(activitiesQuery, (snapshot) => {
                activities = [];
                snapshot.forEach((doc) => {
                    activities.push({ id: doc.id, ...doc.data() });
                });
                
                updateActivityFeed();
                console.log(`üìà ${activities.length} aktivite y√ºklendi`);
            });

            // Listen to notes
            const notesRef = collection(db, 'notes');
            const notesQuery = query(notesRef, orderBy('createdAt', 'desc'));
            
            onSnapshot(notesQuery, (snapshot) => {
                firestoreNotes = [];
                snapshot.forEach((doc) => {
                    firestoreNotes.push({ id: doc.id, ...doc.data() });
                });
                
                renderNotes();
                console.log(`üìù ${firestoreNotes.length} Firebase notu y√ºklendi`);
            });
        }

        // Merge Firebase data with existing project data
        function mergeFirebaseData() {
            // This function would merge Firebase tasks with the original projectData
            // and trigger a re-render of the Gantt chart
            if (typeof updateGanttChart === 'function') {
                updateGanttChart();
            }
        }

        // Add activity to Firebase
        async function addActivity(message) {
            try {
                const activityRef = doc(collection(db, 'activities'));
                await setDoc(activityRef, {
                    message: message,
                    user: currentUser,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Aktivite eklenirken hata:', error);
            }
        }

        // Update activity feed UI
        function updateActivityFeed() {
            const activityContent = document.getElementById('activityContent');
            if (!activityContent) return;

            const activitiesHtml = activities.map(activity => {
                const timeAgo = activity.timestamp ? 'Az √∂nce' : '≈ûimdi';
                return `
                    <div class="activity-item">
                        <div><span class="activity-user">${activity.user}</span> ${activity.message.replace(activity.user, '').trim()}</div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                `;
            }).join('');

            activityContent.innerHTML = activitiesHtml || `
                <div class="activity-item">
                    <div><span class="activity-user">System</span> Firebase baƒülantƒ±sƒ± kuruldu</div>
                    <div class="activity-time">Az √∂nce</div>
                </div>
            `;
        }

        // Activity feed toggle
        window.toggleActivityFeed = function() {
            const feed = document.getElementById('activityFeed');
            feed.classList.toggle('expanded');
        };

        // Enhanced save function with Firebase sync
        window.saveToFirebase = async function(taskData) {
            try {
                const taskRef = doc(collection(db, 'tasks'));
                await setDoc(taskRef, {
                    ...taskData,
                    createdBy: currentUser,
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp(),
                    lastModifiedBy: currentUser
                });
                
                await addActivity(`${currentUser} yeni g√∂rev ekledi: "${taskData.name}"`);
                return true;
            } catch (error) {
                console.error('Firebase kayƒ±t hatasƒ±:', error);
                return false;
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeRealTimeSync();
            
            // Add welcome activity
            setTimeout(() => {
                addActivity(`${currentUser} projeye katƒ±ldƒ±`);
            }, 1000);

            // Add note button event listener
            document.getElementById('addNote').addEventListener('click', addNote);
            
            // Save note button event listener
            document.getElementById('saveNote').addEventListener('click', saveNote);
            
            // Modal close functionality for note modal
            const noteModal = document.getElementById('noteModal');
            const noteCloseButtons = noteModal.querySelectorAll('.close, .close-modal');
            noteCloseButtons.forEach(button => {
                button.addEventListener('click', () => {
                    noteModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                });
            });

            // Click outside modal to close
            window.addEventListener('click', (event) => {
                if (event.target === noteModal) {
                    noteModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                }
            });

            console.log('üî• Real-Time Gantt Chart ba≈ülatƒ±ldƒ±!');
        });

        // Notes functionality
        function renderNotes() {
            // Clear existing notes
            document.querySelectorAll('.gantt-note').forEach(note => note.remove());
            
            // Render Firebase notes
            firestoreNotes.forEach(note => {
                createNoteElement(note);
            });
        }

        function createNoteElement(noteData) {
            // Notes should be positioned relative to the gantt-body, not gantt-chart
            const ganttBody = document.querySelector('.gantt-body');
            if (!ganttBody) return;

            const noteElement = document.createElement('div');
            noteElement.className = `gantt-note ${noteData.color || 'yellow'}`;
            noteElement.dataset.noteId = noteData.id;
            noteElement.style.left = `${noteData.x || 400}px`;
            noteElement.style.top = `${noteData.y || 200}px`;

            const userInitial = noteData.createdBy ? noteData.createdBy.charAt(0).toUpperCase() : 'A';
            const userColor = noteData.createdBy === 'Metin' ? '#FF6B6B' : '#4ECDC4';

            noteElement.innerHTML = `
                <div class="note-content">${noteData.content}</div>
                <div class="note-timestamp">${new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}</div>
                <div class="note-author" style="background: ${userColor}">${userInitial}</div>
                <div class="note-delete" onclick="deleteNote('${noteData.id}')">√ó</div>
            `;

            // Add drag functionality
            addNoteDragFunctionality(noteElement, noteData);
            
            ganttBody.appendChild(noteElement);
        }

        function addNoteDragFunctionality(noteElement, noteData) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            noteElement.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('note-delete')) return;
                
                isDragging = true;
                noteElement.classList.add('dragging');
                
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(noteElement.style.left) || 0;
                startTop = parseInt(noteElement.style.top) || 0;
                
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                const newLeft = Math.max(0, startLeft + deltaX);
                const newTop = Math.max(0, startTop + deltaY);
                
                noteElement.style.left = `${newLeft}px`;
                noteElement.style.top = `${newTop}px`;
            });

            document.addEventListener('mouseup', async () => {
                if (!isDragging) return;
                
                isDragging = false;
                noteElement.classList.remove('dragging');
                
                // Update position in Firebase
                const newX = parseInt(noteElement.style.left);
                const newY = parseInt(noteElement.style.top);
                
                try {
                    const noteRef = doc(db, 'notes', noteData.id);
                    await updateDoc(noteRef, {
                        x: newX,
                        y: newY,
                        lastModified: serverTimestamp(),
                        lastModifiedBy: currentUser
                    });
                    
                    await addActivity(`${currentUser} bir notu ta≈üƒ±dƒ±`);
                } catch (error) {
                    console.error('Not pozisyonu g√ºncellenirken hata:', error);
                }
            });
        }

        // Add note function
        window.addNote = function() {
            document.getElementById('noteModal').style.display = 'block';
            document.body.classList.add('modal-open');
        };

        // Save note function
        window.saveNote = async function() {
            const content = document.getElementById('noteContent').value.trim();
            const color = document.getElementById('noteColor').value;
            
            if (!content) {
                alert('L√ºtfen not i√ßeriƒüi girin!');
                return;
            }

            try {
                const noteRef = doc(collection(db, 'notes'));
                await setDoc(noteRef, {
                    content: content,
                    color: color,
                    x: 400 + Math.random() * 200, // Random initial position
                    y: 200 + Math.random() * 100,
                    createdBy: currentUser,
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp(),
                    lastModifiedBy: currentUser
                });
                
                await addActivity(`${currentUser} yeni not ekledi: "${content.substring(0, 30)}${content.length > 30 ? '...' : ''}"`);
                
                // Close modal and reset form
                document.getElementById('noteModal').style.display = 'none';
                document.body.classList.remove('modal-open');
                document.getElementById('noteContent').value = '';
                document.getElementById('noteColor').value = 'yellow';
                
                console.log('üìù Not ba≈üarƒ±yla kaydedildi');
            } catch (error) {
                console.error('Not kaydedilirken hata:', error);
                alert('Not kaydedilirken bir hata olu≈ütu!');
            }
        };

        // Delete note function
        window.deleteNote = async function(noteId) {
            if (!confirm('Bu notu silmek istediƒüinizden emin misiniz?')) return;
            
            try {
                await deleteDoc(doc(db, 'notes', noteId));
                await addActivity(`${currentUser} bir not sildi`);
                console.log('üìù Not ba≈üarƒ±yla silindi');
            } catch (error) {
                console.error('Not silinirken hata:', error);
                alert('Not silinirken bir hata olu≈ütu!');
            }
        };

        // Export functions to global scope for original script.js compatibility
        window.currentUser = currentUser;
        window.addActivity = addActivity;
        window.saveToFirebase = saveToFirebase;
        window.renderNotes = renderNotes;
    </script>
</body>
</html>
